# 0003. 配置体系与环境变量

## 适合人群
- 有 Java 背景的 Go 初学者，想快速掌握项目的配置加载与常用环境变量。

## 配置加载概览
- 入口：`common/init.go` 负责 flag/环境变量解析，初始化全局配置、密钥、日志目录等。
- 常量：`common/constants.go`、`constant/` 目录集中放置默认值与枚举。
- 数据库选择：`model/main.go` 根据 `SQL_DSN` 解析 SQLite/MySQL/Postgres，默认 SQLite（`one-api.db`）。
- 嵌入资源：`main.go` 使用 Go embed 提供内置静态文件（web/dist）。

## 常用环境变量（重点）
- 安全/密钥
  - `SESSION_SECRET`：会话密钥，多机必配。
  - `CRYPTO_SECRET`：加密密钥，使用 Redis 时必须。
- 数据库
  - `SQL_DSN`：数据库连接串。不设则 SQLite（`one-api.db?_busy_timeout=30000`）。
  - `LOG_SQL_DSN`：日志数据库连接，可与主库分离。
  - `SQLITE_PATH`：自定义 SQLite 路径。
- 端口与模式
  - `PORT`：服务端口，默认 3000。
  - `GIN_MODE`：`debug`/`release`，默认 release。
  - `DEBUG`：`true` 开启调试日志。
- 缓存与队列
  - `REDIS_CONN_STRING`：启用 Redis 缓存/会话/队列。
  - `MEMORY_CACHE_ENABLED`：内存缓存开关。
- 路由/超时
  - `RELAY_TIMEOUT`、`STREAMING_TIMEOUT`、`STREAM_SCANNER_MAX_BUFFER_MB`：转发/流式相关超时与缓冲。
- 其他常见
  - `ERROR_LOG_ENABLED`：错误日志开关。
  - `NODE_TYPE`：`master`/`slave`，影响任务调度与同步。
  - `SYNC_FREQUENCY`：渠道/配置同步频率（秒）。

## 配置读取路径（示例）
- `common/init.go`：flag → env → 默认值，初始化 Session/Crypto、日志目录、调试开关等。
- `common/initConstantEnv()`：加载超时、缓冲等常量型配置。
- `model/main.go`：按 `SQL_DSN` 选择驱动并迁移。
- `main.go`：根据环境决定 Gin 模式、是否启用 pprof/缓存/任务等。

## 开发/测试建议（Go 与 Java 对照）
- 使用 `.env` 或 shell 导出变量；Go 侧区分大小写，不会自动转换下划线/驼峰。
- SQLite 适合本地快速体验；生产建议 MySQL/Postgres，并配置 `SESSION_SECRET`、`CRYPTO_SECRET`、Redis。
- 调试模式：`GIN_MODE=debug`、`DEBUG=true` 可获得更详细日志；注意生产关闭。
- 端口冲突：如 3000 被占用，设置 `PORT=3001`，启动脚本会尝试释放占用后再启动。

## 参考文件
- `common/init.go`、`common/constants.go`
- `constant/`（env、task、channel 等常量）
- `model/main.go`
- `main.go`（Gin 模式、嵌入静态资源）

