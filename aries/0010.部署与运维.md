# 0010. 部署与运维

## 适合人群
- 有基础运维经验的 Go 初学者，关心部署方式、日志与监控。

## 部署方式
- 源码运行：`bin/start-backend.(sh|bat)` + `bin/start-front.(sh|bat)`，适合开发/测试。
- 容器化：
  - 构建：`Dockerfile`
  - 编排：`docker-compose.yml`（默认 3000 端口，挂载 ./data 保存 SQLite）
  - 镜像：`calciumion/new-api:latest`（上游）
- systemd：`new-api.service` 示例，可改 ExecStart/WorkingDirectory。

## 配置与环境
- 关键环境变量：`SESSION_SECRET`、`CRYPTO_SECRET`、`SQL_DSN`、`PORT`、`REDIS_CONN_STRING` 等（见 0003）。
- 多机/Redis：需设置 `CRYPTO_SECRET` 保证加密一致；`NODE_TYPE` 控制主从角色。

## 日志与监控
- 日志位置：`logs/`（按时间命名），包含系统与错误日志。
- Pprof：可选启用，便于性能分析。
- 限流/重试：结合中间件与 relay 策略，避免下游放大。

## 数据与存储
- 默认 SQLite：适合单机测试；生产建议 MySQL/Postgres，并备份。
- 数据持久化：容器模式挂载 `/data` 目录；本地注意权限。

## 升级与迁移
- 拉取代码/镜像后，启动时自动迁移数据库（`model/migrateDB`）。
- 备份数据库与配置，再滚动发布；容器可用新镜像 + 旧数据卷回滚。

## 常用运维动作
- 查看状态：`git status` / 容器 `docker ps`
- 查看日志：`logs/oneapi-*.log` 或容器 `docker logs`
- 重启：systemd `systemctl restart new-api`，或 docker-compose 重启服务
- 端口调整：设置 `PORT` 或修改 compose/systemd 配置

## 参考文件
- `Dockerfile`、`docker-compose.yml`
- `new-api.service`
- `bin/deploy.(sh|bat)`（Git 拉取/提交/推送）

