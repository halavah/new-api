# 0006. 业务服务层

## 适合人群
- 有 Java 背景的 Go 初学者，想了解 service 层职责与常见模式。

## 定位
- 介于 controller 与 model/relay 之间，负责业务编排、校验、计费、路由决策、通知。
- 类比 Java 的 service/manager 层，逻辑集中、可复用，便于测试。

## 常见服务（示例）
- 计费/额度：计费规则、余额/额度扣减、用量统计。
- 路由与分发：根据渠道权重、可用性、模型限制选择转发目标。
- 鉴权与会话：令牌校验、用户校验、权限控制。
- 通知与回调：Stripe/支付回调、异步任务通知。
- 配置与缓存：选项加载、缓存更新、Redis 交互。

## 模式与实践
- 输入以 DTO/实体为主，输出业务结构或错误；避免直接操作 HTTP。
- 事务控制：在 service 内聚合事务（db.Transaction），避免跨层开启事务。
- 幂等与重试：针对扣费/任务类操作考虑请求幂等 key 或状态机。
- 错误处理：返回 error，controller 统一转换为 HTTP 响应。

## 与 Relay 的协作
- service 决定使用哪个渠道/模型、是否重试，Relay 负责具体厂商适配与调用。
- 在路由决策前检查配额、权限、模型可用性。

## 对照 Java 习惯
- 无框架式 DI，依赖多为包级变量/函数参数；注意并发安全。
- 错误处理靠返回值，不使用异常；需要显式检查 error。

## 参考文件
- `service/` 目录各文件（计费、通知、路由、鉴权、缓存等）
- 与之交互的 `relay/`、`model/`、`controller/`

