# 0004. 中间件与安全

## 适合人群
- 有 Java 背景的 Go 初学者，想理解 Gin 中间件链与安全防护。

## 中间件定位
- 类比 Java Filter/Interceptor：在路由前后做横切处理（鉴权、限流、日志、CORS、恢复等）。
- 注册位置：`router/main.go` 及各子路由中按需组合。

## 关键中间件（常见）
- 日志与请求追踪：`middleware/logger.go`、`request-id.go`
- 恢复：`middleware/recover.go`（捕获 panic，防止进程崩溃）
- CORS：`middleware/cors.go`
- 鉴权与安全：
  - `auth.go`（用户鉴权/令牌）
  - `secure_verification.go`、`turnstile-check.go`（安全校验/验证码）
  - `jimeng_adapter.go`、`kling_adapter.go`（特定接入的安全/兼容适配）
- 限流与熔断：
  - `rate-limit.go`、`model-rate-limit.go`
  - `distributor.go`（请求分发与调度）
  - `cache.go`、`disable-cache.go`（缓存控制）
- Gzip：`gzip.go`

## 链路参考（简化）
1) 请求 ID / 日志
2) Recover
3) CORS
4) 鉴权/限流/安全检查
5) 业务处理（controller → service/relay）

## 安全要点
- 会话与密钥：`SESSION_SECRET`、`CRYPTO_SECRET` 必填（多机/Redis）。
- 输入校验：DTO/绑定时进行；必要时在 controller 里补充校验。
- 速率与配额：限流中间件+业务侧计费/配额校验双层保障。
- 跨域：CORS 中间件按需放行，避免默认全开。
- Panic 防护：保持 recover 中间件开启，记录错误日志。

## 对照 Java 习惯
- 没有 Servlet 容器的全局 XML/注解链，Gin 中间件在代码中显式注册。
- 依赖注入多为显式传递/包级变量；关注并发安全（避免在中间件里共享可变状态）。

## 参考文件
- `middleware/` 目录各文件
- `router/main.go`（中间件注册位置）

