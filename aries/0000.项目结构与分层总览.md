# 0000. 项目结构与分层总览

## 项目概览
- 后端：Go 单体服务，承担 API 网关、路由、计费、鉴权、任务调度等核心能力。
- 前端：`web/` 基于 React + Vite（bun 工具链）构建的管理控制台。
- 桌面：`electron/` 提供桌面封装与托盘支持。
- 运维脚本：`bin/`、`manage.(sh|bat)` 用于本地/CI 部署、启动。

## 目录层次
- 根入口
  - `main.go`：服务主入口，初始化配置、路由、服务。
  - `Dockerfile`/`docker-compose.yml`：容器化构建与编排。
  - `new-api.service`：systemd 启动脚本示例。
- 业务与基础分层
  - `common/`：通用基础设施（配置加载、加解密、Redis/SQLite/MySQL/Postgres 适配、PPROF、限流、日志等）。
  - `constant/`：常量、枚举、上下文键、任务/渠道配置常量。
  - `dto/`：请求/响应数据结构定义，解耦控制层与模型层。
  - `model/`：数据模型与数据访问（GORM），含用户、渠道、任务、计费等。
  - `service/`：领域服务与业务逻辑封装（计费、通知、路由、鉴权等）。
  - `relay/`：各厂商/模型的转发与适配（OpenAI/Claude/Gemini 等），路由和回退策略核心实现。
  - `controller/`：HTTP 控制层，处理入站请求、参数校验、调用 service/relay。
  - `middleware/`：Gin 中间件（鉴权、限流、CORS、日志、缓存、安全校验）。
  - `router/`：路由注册与分发（API、Web、Relay、Video 等）。
  - `setting/`：系统配置装载、选项处理（如 Midjourney、聊天等场景设置）。
  - `types/`：类型别名与辅助类型。
- 前端/桌面
  - `web/`：React + Vite 前端源码与构建产物。
  - `electron/`：Electron 主进程、预加载脚本与打包资源。
- 文档与脚本
  - `docs/`：部署、配置、翻译等文档。
  - `bin/`：启动/部署脚本（前后端启动、CI 提交等）。
  - `manage.sh` / `manage.bat`：交互式管理菜单。

## 分层理由
- 职责分离：`controller` 专注 HTTP 入口，`service` 聚焦业务编排，`model` 管数据持久化，`relay` 处理跨厂商转发与策略，减少耦合。
- 可扩展性：新渠道/模型接入集中在 `relay/` 与 `service/`，不影响控制层与数据模型。
- 可维护性：基础设施与通用工具沉淀在 `common/`、常量集中在 `constant/`，便于全局复用与变更。
- 可测试性：DTO 与模型解耦，逻辑集中在 service/relay，便于单元/集成测试。

## 启动与构建角色
- 后端启动：`bin/start-backend.(sh|bat)`，确保数据库/端口准备好后运行 `go run main.go`。
- 前端启动：`bin/start-front.(sh|bat)`，dev 模式 `bun run dev`（默认 5173），生产构建走 Vite build。
- 部署：`bin/deploy.(sh|bat)` 处理 Git 提交/推送；容器化通过 `Dockerfile`/`docker-compose.yml`。

## 总结
该结构以“入口分离 + 业务分层 + 适配层隔离”为核心：入口（controller/router）、业务（service）、数据（model）、适配（relay）、基础设施（common/constant/middleware），前后端与桌面独立目录，辅以脚本和文档，方便扩展新模型、新渠道及不同运行形态（本地、容器、桌面）。

