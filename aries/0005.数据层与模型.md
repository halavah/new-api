# 0005. 数据层与模型

## 适合人群
- 有 Java 背景的 Go 初学者，想理解 GORM 使用与核心模型。

## 数据库选择与初始化
- 默认 SQLite：`one-api.db?_busy_timeout=30000`
- MySQL / Postgres：设置 `SQL_DSN`，`model/main.go` 自动选择驱动并迁移。
- 日志库可分离：`LOG_SQL_DSN`
- 连接池与超时：`SQL_MAX_IDLE_CONNS`、`SQL_MAX_OPEN_CONNS`、`SQL_MAX_LIFETIME`

## 核心模型（示例）
- 用户/鉴权：`model/user.go`、`model/token.go`
- 渠道与路由：`model/channel.go`、`model/channel_cache.go`、`model/vendor_meta.go`
- 计费与额度：`model/ability.go`、`model/quota` 相关、`pricing` 系列
- 任务/队列：`model/task.go`、`model/task_video.go`
- 日志与使用数据：`model/log.go`、`model/usedata.go`

## 迁移与兼容
- `model/main.go` 中 `migrateDB()` 会在启动时自动迁移表结构。
- SQLite/ MySQL/ Postgres 差异：注意 DSN、字符集、时区、parseTime。
- 历史兼容：部分字段/表可能为旧版保留，修改前先检查迁移逻辑。

## GORM 使用要点（与 Java/JPA 对照）
- 结构体标签代替注解：`gorm:"column:..." json:"..."`。
- 事务：`db.Transaction(func(tx *gorm.DB) error { ... })`；谨慎处理错误返回。
- 预编译与性能：`PrepareStmt: true` 已在初始化配置。
- 查询链与指针：注意 nil/零值，区分 `Find`/`First`/`Take`。

## 配置型数据
- 常量/枚举在 `constant/`；运行时选项存储在数据库并缓存，`service`/`setting` 负责加载与刷新。

## 常见坑
- SQLite 并发写：适合小规模/单机，生产建议 MySQL/Postgres。
- parseTime 未设置导致时间解析异常（MySQL DSN 已自动补齐）。
- 大字段/JSON：确认数据库字符集与 collation，避免乱码或截断。

## 参考文件
- `model/` 目录各模型
- `model/main.go`（DB 选择、迁移）
- `constant/`（枚举/常量）

